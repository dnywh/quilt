---
import Layout from "../../layouts/BaseLayout.astro";
import R2Image from "../../components/R2Image.astro";
import { getCollection } from "astro:content";
import { getEphemeraImagePath } from "../../lib/ephemera";

export async function getStaticPaths() {
  const ephemeraItems = await getCollection("ephemera");

  return ephemeraItems.map((item) => ({
    params: { slug: item.id },
    props: { item },
  }));
}

const { item } = Astro.props;

// Helper to format date
function formatDate(date: Date) {
  return date.toLocaleDateString("en-AU", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

// Helper to get image label based on position
function getImageLabel(index: number, total: number): string {
  if (index === 0) return "Front";
  if (total === 2) return "Back";
  if (total === 3) return index === 1 ? "Inside" : "Back";
  return `Image ${index + 1}`;
}
---

<Layout title={`${item.data.name} — Ephemera`}>
  <main class="ephemera-detail">
    <nav class="ephemera-nav">
      <a href="/ephemera" class="back-link">
        <svg
          width="20"
          height="20"
          viewBox="0 0 20 20"
          fill="none"
          aria-hidden="true"
        >
          <path
            d="M12 4l-6 6 6 6"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"></path>
        </svg>
        Back to collection
      </a>
    </nav>

    <article class="ephemera-item">
      <header class="ephemera-header">
        <h1 class="ephemera-name">{item.data.name}</h1>

        <div class="ephemera-meta">
          <time datetime={item.data.date.toISOString()}>
            {formatDate(item.data.date)}
          </time>
          {
            item.data.venue && (
              <span class="ephemera-venue">{item.data.venue}</span>
            )
          }
          {
            item.data.location && (
              <span class="ephemera-location">{item.data.location}</span>
            )
          }
          {
            item.data.country && (
              <span class="ephemera-country">{item.data.country}</span>
            )
          }
        </div>

        {
          item.data.tags.length > 0 && (
            <ul class="ephemera-tags">
              {item.data.tags.map((tag: string) => (
                <li class="ephemera-tag">{tag}</li>
              ))}
            </ul>
          )
        }
      </header>

      <div class="ephemera-gallery">
        <figure class="ephemera-hero">
          <R2Image
            src={getEphemeraImagePath(item.data.images[0], item.data.hasTransparency)}
            width={1200}
            alt={`${item.data.name} — ${getImageLabel(0, item.data.images.length)}`}
            class="ephemera-hero-image"
            fit="scale-down"
            sizes="(max-width: 640px) 100vw, (max-width: 1200px) 90vw, 1200px"
            id="hero-image"
            data-images={JSON.stringify(item.data.images.map((slug: string) => getEphemeraImagePath(slug, item.data.hasTransparency)))}
            data-labels={JSON.stringify(item.data.images.map((_: string, idx: number) => getImageLabel(idx, item.data.images.length)))}
            data-name={item.data.name}
          />
          <figcaption class="ephemera-hero-caption" id="hero-caption">
            {getImageLabel(0, item.data.images.length)}
          </figcaption>
        </figure>

        {item.data.images.length > 1 && (
          <div class="ephemera-thumbnails">
            {item.data.images.map((slug: string, idx: number) => (
              <button
                type="button"
                class={`ephemera-thumb ${idx === 0 ? "active" : ""}`}
                data-index={idx}
                aria-label={`View ${getImageLabel(idx, item.data.images.length)}`}
              >
                <R2Image
                  src={getEphemeraImagePath(slug, item.data.hasTransparency)}
                  width={120}
                  alt=""
                  fit="scale-down"
                  class="ephemera-thumb-image"
                  sizes="120px"
                />
              </button>
            ))}
          </div>
        )}
      </div>

      {
        item.data.notes && (
          <aside class="ephemera-notes">
            <p>{item.data.notes}</p>
          </aside>
        )
      }
    </article>
  </main>
</Layout>

<style>
  .ephemera-detail {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1rem 4rem;
  }

  .ephemera-nav {
    margin-bottom: 2rem;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.9375rem;
    color: #6b7280;
    text-decoration: none;
    transition: color 0.15s;
  }

  .back-link:hover {
    color: #111827;
  }

  .ephemera-item {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .ephemera-header {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .ephemera-name {
    margin: 0;
    font-size: 2rem;
    font-weight: 700;
    color: #111827;
    letter-spacing: -0.02em;
  }

  .ephemera-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem 1rem;
    font-size: 1rem;
    color: #6b7280;
  }

  .ephemera-meta time {
    font-weight: 500;
  }

  .ephemera-venue::before,
  .ephemera-location::before,
  .ephemera-country::before {
    content: "•";
    margin-right: 0.5rem;
    opacity: 0.5;
  }

  .ephemera-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    list-style: none;
    margin: 0.5rem 0 0;
    padding: 0;
  }

  .ephemera-tag {
    padding: 0.375rem 0.75rem;
    font-size: 0.8125rem;
    background: #f3f4f6;
    color: #374151;
    border-radius: 9999px;
  }

  .ephemera-gallery {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .ephemera-hero {
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
  }

  .ephemera-hero-image {
    max-width: 100%;
    max-height: 70vh;
    width: auto;
    height: auto;
    object-fit: scale-down;
  }

  .ephemera-hero-caption {
    font-size: 0.875rem;
    color: #9ca3af;
    text-align: center;
  }

  .ephemera-thumbnails {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
  }

  .ephemera-thumb {
    padding: 0;
    border: 2px solid transparent;
    background: #f3f4f6;
    border-radius: 6px;
    cursor: pointer;
    overflow: hidden;
    transition: border-color 0.15s, opacity 0.15s;
    opacity: 0.7;
  }

  .ephemera-thumb:hover {
    opacity: 1;
  }

  .ephemera-thumb.active {
    border-color: #111827;
    opacity: 1;
  }

  .ephemera-thumb-image {
    display: block;
    width: 80px;
    height: 60px;
    object-fit: contain;
  }

  .ephemera-notes {
    padding: 1.25rem 1.5rem;
    background: #fefce8;
    border-radius: 8px;
    border-left: 3px solid #facc15;
  }

  .ephemera-notes p {
    margin: 0;
    font-size: 0.9375rem;
    color: #713f12;
    line-height: 1.6;
  }

  @media (max-width: 640px) {
    .ephemera-detail {
      padding: 1.5rem 1rem 3rem;
    }

    .ephemera-name {
      font-size: 1.5rem;
    }

    .ephemera-thumb-image {
      width: 60px;
      height: 45px;
    }
  }
</style>

<script>
  const heroImg = document.getElementById("hero-image") as HTMLImageElement;
  const heroCaption = document.getElementById("hero-caption");
  const thumbs = document.querySelectorAll(".ephemera-thumb");

  if (heroImg && thumbs.length > 0) {
    const images: string[] = JSON.parse(heroImg.dataset.images || "[]");
    const labels: string[] = JSON.parse(heroImg.dataset.labels || "[]");
    const name = heroImg.dataset.name || "";

    thumbs.forEach((thumb) => {
      thumb.addEventListener("click", () => {
        const index = parseInt((thumb as HTMLElement).dataset.index || "0", 10);
        const newSrc = images[index];
        const newLabel = labels[index];

        // Update hero image src and srcset
        const baseUrl = heroImg.src.split("/cdn-cgi/")[0];
        const buildUrl = (path: string, width: number) =>
          `${baseUrl}/cdn-cgi/image/width=${width},fit=scale-down,quality=80,format=auto/${path}`;

        heroImg.src = buildUrl(newSrc, 1200);
        heroImg.srcset = [200, 400, 600, 800, 1200, 1600]
          .map((w) => `${buildUrl(newSrc, w)} ${w}w`)
          .join(", ");
        heroImg.alt = `${name} — ${newLabel}`;

        // Update caption
        if (heroCaption) {
          heroCaption.textContent = newLabel;
        }

        // Update active state
        thumbs.forEach((t) => t.classList.remove("active"));
        thumb.classList.add("active");
      });
    });
  }
</script>
