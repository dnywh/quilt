---
import { type HTMLAttributes } from "astro/types";

export interface R2ImageProps extends Omit<
  HTMLAttributes<"img">,
  "src" | "srcset"
> {
  /** Path to the image relative to the R2 bucket root (e.g., 'ephemera/my-image.jpg') */
  src: string;
  /** Original width of the image (used for aspect ratio calculation) */
  width: number;
  /** Original height of the image (used for aspect ratio calculation) */
  height?: number;
  /** Alt text for the image */
  alt: string;
  /** Image fit mode: cover, contain, scale-down, crop, pad */
  fit?: "cover" | "contain" | "scale-down" | "crop" | "pad";
  /** Image quality (1-100), defaults to 80 */
  quality?: number;
  /** Output format: auto (recommended), avif, webp, or original */
  format?: "auto" | "avif" | "webp" | "json";
  /** Device pixel ratio for high-DPI displays */
  dpr?: number;
  /** Custom breakpoints for srcset generation */
  widths?: number[];
  /** Sizes attribute for responsive images. Defaults to "(max-width: 768px) 100vw, 33vw" (conservative estimate for grids). Override for accurate sizing, e.g., "(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 25vw" */
  sizes?: string;
  /** Loading strategy */
  loading?: "lazy" | "eager";
  /** Decoding hint */
  decoding?: "async" | "sync" | "auto";
  /** Fetch priority hint */
  fetchpriority?: "high" | "low" | "auto";
}

interface Props extends R2ImageProps {}

import { R2_BASE_URL } from "../lib/config";

const {
  src,
  width,
  height,
  alt,
  fit = "cover",
  quality = 80,
  format = "auto",
  dpr,
  widths,
  sizes,
  loading = "lazy",
  decoding = "async",
  fetchpriority,
  class: className,
  ...rest
}: Props = Astro.props;

/**
 * Build a Cloudflare R2 image transformation URL
 */
function buildR2Url(
  path: string,
  options: {
    width?: number;
    height?: number;
    fit?: string;
    quality?: number;
    format?: string;
    dpr?: number;
  }
): string {
  const transforms: string[] = [];

  if (options.width) transforms.push(`width=${options.width}`);
  if (options.height) transforms.push(`height=${options.height}`);
  if (options.fit) transforms.push(`fit=${options.fit}`);
  if (options.quality) transforms.push(`quality=${options.quality}`);
  if (options.format) transforms.push(`format=${options.format}`);
  if (options.dpr) transforms.push(`dpr=${options.dpr}`);

  if (transforms.length === 0) {
    return `${R2_BASE_URL}/${path}`;
  }

  return `${R2_BASE_URL}/cdn-cgi/image/${transforms.join(",")}/${path}`;
}

// Calculate aspect ratio for responsive sizing
const aspectRatio = height ? width / height : undefined;

// Generate srcset for responsive images
// Use common responsive breakpoints that work well for containers
const defaultWidths = widths || [400, 600, 800, 1200, 1600, 2400];
const srcsetWidths = defaultWidths;

const srcset = srcsetWidths
  .map((w) => {
    const url = buildR2Url(src, {
      width: w,
      height: height ? Math.round(height * (w / width)) : undefined,
      fit,
      quality,
      format,
    });
    return `${url} ${w}w`;
  })
  .join(", ");

// Default sizes: conservative estimate for typical layouts
// Assumes images are full-width on mobile, ~33% width on larger screens (typical for grids)
// User can override with sizes prop for more specific breakpoints
const defaultSizes = sizes || "(max-width: 768px) 100vw, 33vw";

// Generate a fallback src at a reasonable size (800px is a good default)
const fallbackWidth = 800;
const primarySrc = buildR2Url(src, {
  width: fallbackWidth,
  height: height ? Math.round(height * (fallbackWidth / width)) : undefined,
  fit,
  quality,
  format,
});

// Combine class names
const imageClassName = className ? `r2-image ${className}` : "r2-image";
---

<img
  src={primarySrc}
  srcset={srcset}
  sizes={defaultSizes}
  width={width}
  height={height}
  alt={alt}
  loading={loading}
  decoding={decoding}
  fetchpriority={fetchpriority}
  class={imageClassName}
  style={aspectRatio ? `aspect-ratio: ${width} / ${height};` : undefined}
  {...rest}
/>

<style>
  .r2-image {
    width: 100%;
    height: auto;
    display: block;
  }
</style>
