---
import { getCollection, getEntry } from "astro:content";
import R2Image from "./R2Image.astro";

interface Props {
  /** Limit to the latest N items (sorted by date descending). No pagination when set. */
  limit?: number;
  /** Fetch a specific item by its ID (the first image slug) */
  itemId?: string;
  /** Items to show per page (default: 24) */
  pageSize?: number;
}

const { limit, itemId, pageSize = 24 } = Astro.props;

// Fetch items based on props
let items: Awaited<ReturnType<typeof getCollection<"ephemera">>>;

if (itemId) {
  // Fetch a single item by ID
  const entry = await getEntry("ephemera", itemId);
  items = entry ? [entry] : [];
} else {
  // Fetch all items and sort by date descending (newest first)
  const allItems = await getCollection("ephemera");
  const sorted = allItems.sort(
    (a, b) => b.data.date.getTime() - a.data.date.getTime()
  );

  // Apply limit if specified
  items = limit ? sorted.slice(0, limit) : sorted;
}

// Determine if we need pagination (only when showing all items, not with limit or itemId)
const needsPagination = !limit && !itemId && items.length > pageSize;
const totalItems = items.length;

// Helper to format date (now receives a Date object)
function formatDate(date: Date) {
  return date.toLocaleDateString("en-AU", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
}

// Helper to build R2 image path
function r2ImagePath(slug: string) {
  return `ephemera/${slug}.jpg`;
}

// Helper to get image label based on position
function getImageLabel(index: number, total: number): string {
  if (index === 0) return ""; // Front/main image
  if (total === 2) return " (back)";
  if (total === 3) return index === 1 ? " (inside)" : " (back)";
  return "";
}
---

{
  items.length === 0 ? (
    <p class="ephemera-empty">No ephemera found.</p>
  ) : (
    <section class="ephemera" data-page-size={pageSize}>
      {items.map((item, index) => (
        <article
          class:list={[
            "ephemera-item",
            { "ephemera-hidden": needsPagination && index >= pageSize },
          ]}
          data-id={item.id}
        >
          <div class="ephemera-images">
            {item.data.images.map((slug, idx) => (
              <R2Image
                src={r2ImagePath(slug)}
                width={400}
                height={300}
                alt={`${item.data.name}${getImageLabel(idx, item.data.images.length)}`}
                class="ephemera-image"
                sizes="(max-width: 640px) 100vw, 320px"
              />
            ))}
          </div>

          <div class="ephemera-content">
            <h3 class="ephemera-name">{item.data.name}</h3>

            <div class="ephemera-meta">
              <time datetime={item.data.date.toISOString()}>
                {formatDate(item.data.date)}
              </time>
              {item.data.venue && (
                <span class="ephemera-venue">{item.data.venue}</span>
              )}
              {item.data.location && (
                <span class="ephemera-location">{item.data.location}</span>
              )}
            </div>

            {item.data.tags.length > 0 && (
              <ul class="ephemera-tags">
                {item.data.tags.map((tag) => (
                  <li class="ephemera-tag">{tag}</li>
                ))}
              </ul>
            )}

            {item.data.notes && <p class="ephemera-notes">{item.data.notes}</p>}
          </div>
        </article>
      ))}

      {needsPagination && (
        <div class="ephemera-pagination">
          <button class="ephemera-load-more" type="button">
            Load more
            <span class="ephemera-count">
              (showing <span data-visible>{pageSize}</span> of {totalItems})
            </span>
          </button>
        </div>
      )}
    </section>
  )
}

{needsPagination && (
  <script>
    const section = document.querySelector(".ephemera") as HTMLElement;
    const button = document.querySelector(".ephemera-load-more") as HTMLButtonElement;
    const visibleCount = document.querySelector("[data-visible]") as HTMLSpanElement;
    const pageSize = parseInt(section?.dataset.pageSize || "24", 10);
    const items = section?.querySelectorAll(".ephemera-item") as NodeListOf<HTMLElement>;
    const total = items?.length || 0;
    let shown = pageSize;

    button?.addEventListener("click", () => {
      const nextBatch = Math.min(shown + pageSize, total);
      
      for (let i = shown; i < nextBatch; i++) {
        items[i]?.classList.remove("ephemera-hidden");
      }
      
      shown = nextBatch;
      visibleCount.textContent = String(shown);

      if (shown >= total) {
        button.parentElement?.remove();
      }
    });
  </script>
)}

<style>
  .ephemera {
    display: grid;
    gap: 2rem;
  }

  .ephemera-item {
    display: grid;
    gap: 1rem;
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.85);
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.08);
  }

  .ephemera-images {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .ephemera-image {
    border-radius: 8px;
    object-fit: cover;
    max-width: 100%;
    height: auto;
  }

  .ephemera-content {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .ephemera-name {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
  }

  .ephemera-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem 1rem;
    font-size: 0.875rem;
    color: #6b7280;
  }

  .ephemera-meta time {
    font-weight: 500;
  }

  .ephemera-venue::before,
  .ephemera-location::before {
    content: "â€¢";
    margin-right: 0.5rem;
    opacity: 0.5;
  }

  .ephemera-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    list-style: none;
    margin: 0.5rem 0 0;
    padding: 0;
  }

  .ephemera-tag {
    padding: 0.25rem 0.625rem;
    font-size: 0.75rem;
    background: #f3f4f6;
    color: #374151;
    border-radius: 9999px;
  }

  .ephemera-notes {
    margin: 0.5rem 0 0;
    font-size: 0.875rem;
    color: #4b5563;
    font-style: italic;
  }

  .ephemera-empty {
    color: #6b7280;
    font-style: italic;
  }

  .ephemera-hidden {
    display: none;
  }

  .ephemera-pagination {
    grid-column: 1 / -1;
    display: flex;
    justify-content: center;
    padding: 1rem 0;
  }

  .ephemera-load-more {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    font-size: 0.9375rem;
    font-weight: 500;
    color: #374151;
    background: #fff;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    cursor: pointer;
    transition:
      background 0.15s,
      border-color 0.15s;
  }

  .ephemera-load-more:hover {
    background: #f9fafb;
    border-color: #9ca3af;
  }

  .ephemera-count {
    font-weight: 400;
    color: #6b7280;
    font-size: 0.875rem;
  }

  @media (min-width: 640px) {
    .ephemera-item {
      grid-template-columns: auto 1fr;
    }

    .ephemera-images {
      max-width: 320px;
    }
  }
</style>
